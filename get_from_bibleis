#!/bin/sh
## adran festvox er mwyn nol sain a testun o bible.io
#
# languageid:   Ar amser ysgryfnnu mae 6 id rhydym yn angen am nol y ddau verswn beible
#               I ddechra mond text_plain & audio sydd yn cael eiu ddefnydio.
# {
#   "id": "WLSBCN",
#   "type": "text_plain",
#   "size": "NT"
# }, {
#   "id": "WLSBCN",
#   "type": "text_format",
#   "size": "NT"
# }, {
#   "id": "WLSBCNN2DA16",
#   "type": "audio_drama",
#   "size": "NT"
# }, {
#   "id": "WLSBCNN1DA16",
#   "type": "audio",
#   "size": "NT"
# }, {
#   "id": "WLSBCNN2DA",
#   "type": "audio_drama",
#   "size": "NT"
# }, {
#   "id": "WLSBCNN1DA",
#   "type": "audio",
#   "size": "NT"
# }

if [[ $BIBLEIS_API_KEY == "" ]]; then
  export BIBLEIS_API_KEY="52e62d4c-f7c8-4a8b-9008-8634d0fbddb0"
fi

# id nol gwybodaith api
languageid='CYMRNWB'
api_index="https://api.v4.dbt.io/bibles/$languageid?v=4&key=$BIBLEIS_API_KEY"

textid='WLSBCN'
audioids=('N1DA' 'N1DA16')

if [ "$1" = "test" ]
then
  cd test
fi

# creu llefoidd i cadw y sain & tesun
mkdir -p download/mp3
mkdir -p download/txt

echo $api_index >download/starturl
echo $languageid > download/languageid

api_audio="https://api.v4.dbt.io/bibles/filesets/$textid${audioids[0]}?v=4&key=$BIBLEIS_API_KEY&type=audio"
wget -O audio.json $api_audio || echo "api wedi newid!" exit 1

sed -i'.json' 's/},{/},\n{/g' audio.json
sed -i'.json' 's/{"data"\:\[//g' audio.json
while read json_object; do
  mp3=`echo $json_object | grep '"path":"[^"]*' -o | sed 's/"path":"//g'`
  fname=`echo $mp3 | grep '[^/]*\?' -o | sed 's/?//g'`
  wget -O download/mp3/$fname $mp3
  # bookid=`echo $json_object | cut -d'"' -f4`
  # chapterid=`echo $json_object | cut -d'"' -f11 | sed 's/[:,]//g'`
  # echo $fname >>download/flist
  # echo $json_object
  # exit 0
  # api_text="https://api.v4.dbt.io/bibles/filesets/$textid/$bookid/$chapterid?v=4&key=$BIBLEIS_API_KEY&type=text"
  # wget -O $fname.json $api_text
  # grep -o 'verse_text":"[^"]*' $fname.json | cut -d'"' -f3 > download/txt/$fname.txt
  # rm $fname.json
done < audio.json

exit 0

# echo $2 >download/starturl
# echo $languageid > download/languageid
# wget -O books.json $api_index || exit 1
#
# grep -o 'language":"[^"]*' books.json | cut -d'"' -f3 > download/languagename
#
# fieldsetid=`grep -o 'dbp-prod":\[{"id":"[^"]*' books.json | cut -d'"' -f5`
# api_audio="https://api.v4.dbt.io/bibles/filesets/$fieldsetid?v=4&key=$BIBLEIS_API_KEY&type=audio"
# wget -O audio.json $api_audio || exit 1
#
# sed -i 's/},{/},\n{/g' audio.json
# sed -i 's/{"data"\:[//g' audio.json
# while read json_object; do
#   bookid=`echo $json_object | cut -d'"' -f4`
#   chapterid=`echo $json_object | cut -d'"' -f11 | sed 's/[:,]//g'`
#   mp3=`echo $json_object | grep '"path":"[^"]*' -o | sed 's/"path":"//g'`
#
#   fname=`echo $mp3 | grep '[^/]*\.mp3' -o | sed 's/.mp3//g'`
#   echo $fname >>download/flist
#   wget -O download/mp3/$fname.mp3 $mp3
#
#   api_text="https://api.v4.dbt.io/bibles/filesets/$languageid/$bookid/$chapterid?v=4&key=$BIBLEIS_API_KEY&type=text"
#   wget -O $fname.json $api_text
#   grep -o 'verse_text":"[^"]*' $fname.json | cut -d'"' -f3 > download/txt/$fname.txt
#   rm $fname.json
# done < audio.json
#
# exit 0
